# device-drivers
# Описание к SDK для драйвера весов
https://github.com/evotor/device-drivers

1. Подключить проект из github https://github.com/evotor/device-drivers

2. Надо определить внешний сервис c интент-фильтрами INTENT_FILTER_DRIVER_MANAGER и INTENT_FILTER_SCALES.
```
<service>
    <INTENT_FILTER_DRIVER_MANAGER>
    <INTENT_FILTER_SCALES>
</service>
```

    *Здесь и далее по тексту все имена констант указаны из ru.evotor.devices.drivers.Constants.*

### Как должен работать сервис:
При подключении к сервису с action'ом INTENT_FILTER_DRIVER_MANAGER - драйвер должен вернуть Binder наследник ru.evotor.devices.drivers.IUsbDriverManagerService.
Это класс для управления драйверами: подключение и отключение устройств происходят здесь. Надо реализовать методы addUsbDevice и destroy.

При подключении к сервису с action'ом INTENT_FILTER_SCALES драйвер должен вернуть Binder наследник ru.evotor.devices.drivers.IScalesDriverService. Это класс для работы с конкретными экземплярами весов. Надо реализовать метод getWeight.

### Описание методов
Метод addUsbDevice в IUsbDriverManagerService принимает на вход 1) UsbDevice, для которого он создан, 2) некоторый строковый идентификатор номера физического usb-порта (может потребоваться, например, если надо сохранить какие-либо настройки оборудования и восстановить их после перезагрузки терминала). В этот момент у приложения-драйвера уже есть peremission для работы с этим устройством.
Метод ****addUsbDevice()**** возвращает номер экземпляра драйвера внутри приложения. По этому номеру будет происходить обращение к конкретному драйверу (а их, потенциально, может быть больше чем 1 в системе одновременно).

Иконки добавить ...?

Метод ****destroy()**** в IUsbDriverManagerService принимает на вход номер экземпляра драйвера и подготавливает приложение к отключению от устройства.



Метод ****getWeight()**** в IScalesDriverService принимает на вход номер экземпляра драйвера.

Метод ****getWeight()**** возвращает объект класса ru.evotor.devices.drivers.scales.Weight. В конструкторе требуется указать 1) считанный вес, в тех единицах измерения, в которых его вернули весы, 2) коэффициент для приведения веса в граммы, 3) поддерживают ли весы флаг стабильности, 4) флаг стабильности.



При подключении оборудования к терминалу (и, может быть, выбора драйвера пользователем) сервис оборудование подключается (bind) к приложению-драйверу по обоим указанным интент-фильтрам, после подключения передав в метод ****addUsbDevice()**** вставленный UsbDevice.

При запросе на взвешивание сервис оборудования вызовет метод ****getWeight()****.

При отключении оборудования от терминала (или отключения драйвера пользователем) будет вызван метод ****destroy()**** и сервис оборудования отключится (unbind) от приложения-драйвера. Внутренне примечание: пока этот метод не вызывается, мы просто отключаемся. Надо будет дописать.



Т.к. драйверов может быть несколько, для удобства их хранения в каком-нибудь списке можно использовать интерфейс ru.evotor.devices.drivers.scales.IScales. Но, вообще говоря, не обязательно.



В манифесте приложения у сервиса должны быть указаны android:icon и android:label - картинка и имя драйвера (показывается пользователю). Также в манифесте в мета-дате должны быть указаны нужные параметры, имена которых хранятся в константах SERVICE_META_DATA_*. Например, так надо указать имя и модель целевого устройства, VID и PID, категория устройства (SCALES для весов), и имя активити настроек, если оно нужно. Например, это выглядит так: <meta-data android:name="vendor_name" android:value="Штрих-М" /> или
'''<meta-data android:name="usb_device" android:value="VID_1659PID_8963" />.'''
